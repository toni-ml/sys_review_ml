#*******************************************************************************
#*******************************************************************************
#############################     split      ###################################
#*******************************************************************************
#*******************************************************************************

# save split for each variant of data for embedding data

#*******************************************************************************

#-----------------------
tic("total script: 14_split_embedding.R")
#-----------------------

#*******************************************************************************
########################      load data     ####################################
#*******************************************************************************

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# load data
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

#-----------------------
tic("load data")
#-----------------------

load("00data/rdata/01preprocessing/09_grid_sl.RData")
f <- !paste0("ls_split_", grid_sl$data_id_config, ".RDS") %in% list.files(path = "00data/rdata/01preprocessing/14_split_ftunes/")
grid_sl <- grid_sl[f,]

#-----------------------
toc()
#-----------------------
#*******************************************************************************
##################      save split single core          ########################
#*******************************************************************************

# #+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# save split
# #+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

# #-++++++++++++++++++++++
# tic("save split")
# #+++++++++++++++++++++++
# pb <- txtProgressBar(max = nrow(grid_sl), style = 3, width = 100)
# for(j in 1:nrow(grid_sl)){
#   store_split_ftunes(j)
#   setTxtProgressBar(pb, j)
# }
# close(pb)
# #+++++++++++++++++++++++
# toc()
# #+++++++++++++++++++++++

#*******************************************************************************
##################      save split multi core parlapplylb      #################
#*******************************************************************************

#-----------------------
tic("save token")
#-----------------------
opb <- pboptions(style = 1, char = "=",txt.width=80, use_lb = TRUE)
cores <- tidy_cores()
cl <- makeCluster(cores, outfile = "", type='SOCK')
registerDoSNOW(cl)
clusterExport(cl=cl, varlist=c("grid_sl", "df_data", "df_data_u02", "df_data_u03", "df_data_u03", "df_data_u04", "df_data_u05", "ls_id"), envir=environment())
clusterEvalQ(cl, library(tidyverse))
clusterEvalQ(cl, library(tictoc))

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# save token
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

pblapply(X = 1:nrow(grid_sl), store_split_embedding, cl = cl)

stopCluster(cl)
#-----------------------
toc()
#-----------------------

#*******************************************************************************
########################      remove objects     ###############################
#*******************************************************************************

rm(list = ls()[ls() %in%
                 c(
                   "loop_pack",
                   "start",
                   "end",
                   "grid_pack"
                 )])

#*******************************************************************************
########################      save image     ###################################
#*******************************************************************************

#+++++++++++++++++++++++
toc()
#+++++++++++++++++++++++
