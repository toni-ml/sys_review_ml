#*******************************************************************************
#*******************************************************************************
#############################     dtm      #####################################
#*******************************************************************************
#*******************************************************************************

# save dtm for each variant of data

#*******************************************************************************

#+++++++++++++++++++++++
tic("total script: 11_dtm.R")
#+++++++++++++++++++++++

#*******************************************************************************
########################      load data     ####################################
#*******************************************************************************

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# load data
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

#+++++++++++++++++++++++
tic("load data")
#+++++++++++++++++++++++

load("00data/rdata/01preprocessing/09_grid_sl.RData")
f <- !paste0("dtm_", grid_sl$data_id_config, ".RDS") %in% list.files(path = "00data/rdata/01preprocessing/11_dtm/")
grid_sl <- grid_sl[f,]

#+++++++++++++++++++++++
toc()
#+++++++++++++++++++++++

# #*******************************************************************************
# ##################      save dtm single core            ########################
# #*******************************************************************************
# 
# #+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# # save dtm
# #+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# 
# #+++++++++++++++++++++++
# tic("save token and dtm")
# #+++++++++++++++++++++++
# pb <- txtProgressBar(max = nrow(grid_sl), style = 3, width = 100)
# for(j in 1:nrow(grid_sl)){
# store_dtm(j)
#   setTxtProgressBar(pb, j)
# }
# close(pb)
# #+++++++++++++++++++++++
# toc()
# #+++++++++++++++++++++++

# #*******************************************************************************
# ##################      save dtm multi core  foreach           #################
# #*******************************************************************************
# 
# # use grid_pack for memory use in foreach
# loop_pack <- 50
# loop_pack <- tidy_cores()
# start <- c(1, 1 + seq(nrow(grid_sl)/loop_pack) * loop_pack)
# end <- c(seq(nrow(grid_sl)/loop_pack) * loop_pack, loop_pack)
# end[length(end)] <- nrow(grid_sl)
# grid_pack <- data.frame(start, end)
# 
# #+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# # save dtm
# #+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# 
# #+++++++++++++++++++++++
# tic("save dtm")
# #+++++++++++++++++++++++
# 
# for (i in 1:nrow(grid_pack)) {
#   cores <- tidy_cores()
#   cl <- makeCluster(cores, outfile = "", type='SOCK')
#   registerDoSNOW(cl)
# 
#   pb <- txtProgressBar(max = length(grid_pack$start[i]:grid_pack$end[i]), style = 3)
#   progress <- function(n) setTxtProgressBar(pb, n)
#   opts <- list(progress = progress)
# 
#   foreach(
#     j = grid_pack$start[i]:grid_pack$end[i],
#     .options.snow = opts,
#     .packages = c("tidyverse", "tidytext", "qdapTools", "tm", "tictoc"),
#     .export = c("df_data", "df_data_u02", "df_data_u03", "df_data_u03", "df_data_u04", "df_data_u05")
#   ) %dopar% {
#     store_dtm(j)
#   }
#   stopCluster(cl)
#   close(pb)
# }
# #+++++++++++++++++++++++
# toc()
# #+++++++++++++++++++++++

#*******************************************************************************
##################      save dtm multi core  parlapplylb           #############
#*******************************************************************************

#+++++++++++++++++++++++
tic("save dtm")
#+++++++++++++++++++++++
opb <- pboptions(style = 1, char = "=",txt.width=80, use_lb = TRUE)
cores <- tidy_cores()
cl <- makeCluster(cores, outfile = "", type='SOCK')
registerDoSNOW(cl)
clusterExport(cl = cl, varlist = c("matrix2tibble","tidyDataTFidf", "grid_sl", "df_data", "df_data_u02", "df_data_u03", "df_data_u03", "df_data_u04", "df_data_u05"), envir=environment())
clusterEvalQ(cl, library(tidyverse))
clusterEvalQ(cl, library(tidytext))
clusterEvalQ(cl, library(qdapTools))
clusterEvalQ(cl, library(tm))
clusterEvalQ(cl, library(tictoc))

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# save token
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

pblapply(X = 1:nrow(grid_sl), store_dtm, cl = cl)

stopCluster(cl)
#+++++++++++++++++++++++
toc()
#+++++++++++++++++++++++


#*******************************************************************************
########################      remove objects     ###############################
#*******************************************************************************

rm(list = ls()[ls() %in%
                 c(
                   "loop_pack",
                   "start",
                   "end",
                   "grid_pack"
                 )])

#*******************************************************************************
########################      save image     ###################################
#*******************************************************************************

#+++++++++++++++++++++++
toc()
#+++++++++++++++++++++++
